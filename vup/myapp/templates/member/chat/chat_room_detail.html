<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <title>HOME</title> -->
    <title>ห้อง : {{ chat_room.name }}</title>
    
    {% load static %}
    <link rel="stylesheet" href="{% static 'css\css_member\chat\chat_room_detail.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Taviraj:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@100..700&display=swap" rel="stylesheet">
</head>

<body>

    
    
<div class="chat-room">
    <h1>ห้องแชท : {{ chat_room.name }} {{ chat_room.id }}</h1>
    <!-- <h2>ห้องแชท: {{ chat_room.name }}</h2> -->
    <!-- <p>กิจกรรม : {{ chat_room.name  }}</p> -->
    <!-- <p>เจ้าของกิจกรรม : {{ chat_room.created_by.username }}</p> -->
    <!-- <p>ผู้เข้าร่วม :
        <ul>
            {% for member in chat_room.members.all %}
                <li>{{ member.username }}</li>
            {% endfor %}
        </ul>
    </p> -->

    <div class="chat-container">
        <div id="chat-log">
            {% for message in messages %}
                {% if message.is_system_message %}
                    <!-- ข้อความระบบ -->
                    <div class="system-message">
                        <p>{{ message.message }}</p>  
                    </div>
                {% else %}
                    <!-- ข้อความจากผู้ใช้ -->
                    <div class="chat-message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                        
                        <!-- ถ้าคนอื่นส่งข้อความ -->
                        {% if message.sender != request.user %}
                            <div class="message-header">
                                <img src="{{ message.sender.profile.url }}" alt="Profile Picture" class="profile-pic">
                                <p class="sender-name">{{ message.sender.username }}</p>
                            </div>
                        {% else %}
                            <!-- ถ้าเราเป็นคนส่ง -->
                            <div class="message-header sent-header">
                                <img src="{{ message.sender.profile.url }}" alt="Profile Picture" class="profile-pic">
                                <p class="sender-name">{{ message.sender.username }}</p>
                                <!-- <img src="{{ message.sender.profile.url }}" alt="Profile Picture" class="profile-pic"> -->
                            </div>
                        {% endif %}
    
                        <div class="message-body">
                            <div class="message-content">
                                <p class="message-text">{{ message.message }}</p>
                                <p class="message-time">{{ message.created_at|date:"H:i, d M Y" }}</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    
        <!-- ฟอร์มส่งข้อความ -->
        <form method="post" action="{% url 'chat_room' chat_room_id=chat_room.id %}" class="chat-input-form">
            {% csrf_token %}
            <input type="text" name="message" class="chat-input" placeholder="typing here..." required>
            <button type="submit" class="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
    
    
    
    
    
    


         <!-- แสดงข้อความแชท -->
        <!-- {% for message in messages %}
            <div class="message">
                <div class="message-info">
                    {% if message.is_system_message %}
            
                        <div class="system-message">
                            <p>{{ message.message }}</p>  
                        </div>
                    {% else %}
                      
                        <img src="{% if message.sender.profile %}{{ message.sender.profile.url }}{% else %}{% static 'images/default-profile.png' %}{% endif %}" alt="{{ message.sender.username }}'s profile picture" class="profile-picture">
                        <strong>{{ message.sender.username }}</strong>
                        <span>{{ message.created_at|date:"H:i:s" }}</span>
                        <p>{{ message.message }}</p>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <p>ยังไม่มีข้อความในห้องแชท</p>
        {% endfor %} -->

    
    
    <!-- <div id="chat-log">
        {% for message in messages %}
                {% if message.is_system_message %}
                   
                       
                        <li class="system-message">
                            <p class="system-text">{{ message.message }}</p>
                        </li>   
                  
                  
                {% else %}
                    
                    <li class="user-message">
                        <div class="message-info">
                            <span class="sender">{{ message.sender.username }}</span>
                            <span class="timestamp">{{ message.created_at|date:"H:i:s" }}</span>
                        </div>
                        <div class="message-chat">
                            <p class="message-content">{{ message.message }}</p>
                        </div>
                        
                    </li>
                {% endif %}
            {% empty %}

            {% endfor %}
      
    </div> -->
    <!-- <input id="chat-message-input" type="text" placeholder="Type your message here...">
    <button id="chat-message-submit">ส่ง</button> -->

    
</body>

<!-- แชทเรียลไทม์ WebSocket -->
<script>
    let chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/{{ chat_room.id }}/`);

    chatSocket.onmessage = function(event) {
        let data = JSON.parse(event.data);
        let chatLog = document.getElementById("chat-log");

        let messageHTML = `
            <div class="chat-message ${data.sender === "{{ request.user.username }}" ? "sent" : "received"}">
                <div class="message-header ${data.sender === "{{ request.user.username }}" ? 'sent-header' : ''}">
                    <img src="${data.sender_profile}" alt="Profile Picture" class="profile-pic">
                    <p class="sender-name">${data.sender}</p>
                </div>
                <div class="message-body">
                    <div class="message-content">
                        <p class="message-text">${data.message}</p>
                        <p class="message-time">${data.created_at}</p>
                    </div>
                </div>
            </div>
        `;
        chatLog.innerHTML += messageHTML;
    };

    document.querySelector(".chat-input-form").onsubmit = function(event) {
        event.preventDefault();
        let messageInput = document.querySelector(".chat-input");
        let message = messageInput.value;

        chatSocket.send(JSON.stringify({"message": message}));
        messageInput.value = "";
    };
</script>

<!-- เลื่อนลงล่างตอนมีข้อความ-->
<script>
    function scrollToBottom() {
        let chatLog = document.getElementById("chat-log");
        if (chatLog) {
            requestAnimationFrame(() => {
                chatLog.scrollTop = chatLog.scrollHeight;
            });
        }
    }

    let chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/{{ chat_room.id }}/`);

    chatSocket.onmessage = function(event) {
        let data = JSON.parse(event.data);
        let chatLog = document.getElementById("chat-log");

        let messageHTML = `
            <div class="chat-message ${data.sender === "{{ request.user.username }}" ? "sent" : "received"}">
                <div class="message-header ${data.sender === "{{ request.user.username }}" ? 'sent-header' : ''}">
                    <img src="${data.sender_profile}" alt="Profile Picture" class="profile-pic">
                    <p class="sender-name">${data.sender}</p>
                </div>
                <div class="message-body">
                    <div class="message-content">
                        <p class="message-text">${data.message}</p>
                        <p class="message-time">${data.created_at}</p>
                    </div>
                </div>
            </div>
        `;
        chatLog.innerHTML += messageHTML;
        scrollToBottom();  // เรียกใช้ฟังก์ชันให้เลื่อนลงล่างสุด
    };

    document.querySelector(".chat-input-form").onsubmit = function(event) {
        event.preventDefault();
        let messageInput = document.querySelector(".chat-input");
        let message = messageInput.value;

        chatSocket.send(JSON.stringify({"message": message}));
        messageInput.value = "";
        scrollToBottom();  // ให้เลื่อนลงหลังจากส่งข้อความ
    };

    // เลื่อนลงล่างสุดเมื่อโหลดหน้า
    window.onload = function() {
        scrollToBottom();
    };
</script>




<!-- เรียลไทม์แบบ ajax -->
<!-- <script>
    // ฟังก์ชันโหลดข้อความใหม่ทุก 2 วินาที
    function fetchMessages() {
        $.ajax({
            url: window.location.href, // ดึง URL ของหน้านี้
            type: "GET",
            headers: { "X-Requested-With": "XMLHttpRequest" }, // เช็คว่าเป็น AJAX Request
            success: function(data) {
                let chatLog = $("#chat-log");
                chatLog.empty();  // ล้างข้อความเก่า

                data.messages.forEach(function(message) {
                    let messageClass = message.is_sender ? "sent" : "received";

                    let messageHTML = `
                        <div class="chat-message ${messageClass}">
                            <div class="message-header ${message.is_sender ? 'sent-header' : ''}">
                                <img src="${message.sender_profile}" alt="Profile Picture" class="profile-pic">
                                <p class="sender-name">${message.sender}</p>
                            </div>
                            <div class="message-body">
                                <div class="message-content">
                                    <p class="message-text">${message.message}</p>
                                    <p class="message-time">${message.created_at}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    chatLog.append(messageHTML);
                });
            }
        });
    }

    // โหลดข้อความใหม่ทุก 2 วินาที
    setInterval(fetchMessages, 2000);

    // ฟังก์ชันส่งข้อความโดยไม่ต้องโหลดหน้าใหม่
    $(document).ready(function() {
        $(".chat-input-form").submit(function(event) {
            event.preventDefault();  // ป้องกันการโหลดหน้าใหม่
            let form = $(this);
            let messageInput = $(".chat-input");

            $.ajax({
                url: form.attr("action"),
                type: "POST",
                data: form.serialize(),
                headers: { "X-Requested-With": "XMLHttpRequest" },
                success: function(response) {
                    messageInput.val("");  // เคลียร์ช่องข้อความ
                    fetchMessages();  // โหลดข้อความใหม่ทันที
                }
            });
        });
    });
</script> -->


<!-- 
<script>
    const roomId = "{{ chat_room.id }}";  // ดึง chat_room_id จาก template
    const username = "{{ request.user.username }}";  

    // สร้าง WebSocket Connection
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomId + '/'
    );

    // รับข้อความจาก WebSocket
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const sender = data.sender;
        const createdAt = data.created_at;  // รับเวลาจาก WebSocket

        const chatLog = document.getElementById('chat-log');
        chatLog.innerHTML += `<b>${sender}:</b> ${message} <span class="timestamp">(${createdAt})</span><br>`;
        chatLog.scrollTop = chatLog.scrollHeight;  // เลื่อนลงไปที่ข้อความล่าสุด
    };

    // เมื่อ WebSocket ปิด
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // ส่งข้อความเมื่อกดปุ่ม Send
    document.getElementById('chat-message-submit').onclick = function() {
        const messageInputDom = document.getElementById('chat-message-input');
        const message = messageInputDom.value;

        // ส่งข้อความไปที่ WebSocket
        chatSocket.send(JSON.stringify({
            'message': message,
            'username': username
        }));

        messageInputDom.value = '';  // ล้างข้อความหลังส่ง
    };

    // ส่งข้อความเมื่อกด Enter
    document.getElementById('chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // ตรวจสอบว่าเป็นปุ่ม Enter
            document.getElementById('chat-message-submit').click();
        }
    };
</script>  -->

</html>
