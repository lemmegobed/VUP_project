<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar and Notification</title>

    {% load static %}
    <link href="{% static 'css/css_member/notification.css' %}" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.9.0/main.min.js"></script>
</head>

<div class="calendar-notification">
    <!-- Calendar Section -->
    <div class="calendar-container">
        <h1><i class="fas fa-calendar-alt"></i> Calendar</h1>
        <div class="calendar-box">
            <div id="calendar"></div>
            <!-- <div id="calendar"></div> -->
        </div> 
    </div>

  

    <!-- Notification Section -->
    <!-- <div class="notification-container">
        <h1><i class="fas fa-bell"></i> Notification</h1>
        <div class="notification-content">
            <ul>
                {% for notification in notifications %}
                    <li class="{% if not notification.is_read %}unread{% endif %}">
                        <div class="icon-noti">
                            <i class="fa-solid fa-circle"></i>
                        </div>
                        <p>{{ notification.message }}</p>
                        {% if notification.related_event %}
                            <p>‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: {{ notification.related_event.event_name }}</p>
                        {% endif %}
                    </li>
                {% empty %}
                    <li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</li>
                {% endfor %}
            </ul>
        </div>
    </div> -->
    
    

    <!-- <div class="notification-container">
        <h1><i class="fas fa-bell"></i> Notification</h1>
        <div class="notification-content">
            <ul>
                {% for notification in notifications %}
                    <li class="{% if not notification.is_read %}unread{% endif %}">
                        <div class="icon-noti">
                            <i class="fa-solid fa-circle"></i>
                        </div>
                        <p>{{ notification.message }}</p>
                        {% if notification.related_event %}
                            <p>‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: {{ notification.related_event.event_name }}</p>
                        {% endif %}
                    </li>
                {% empty %}
                    <li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</li>
                {% endfor %}
            </ul>
        </div>
    </div> -->
    
    <div class="notification-container">
        <h1><i class="fas fa-bell"></i> Notification</h1>
    <div class="notification-content">
        
        <ul>
            {% for notification in user.notifications.all %}
                <!-- ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó request -->
                {% if notification.notification_type == "request" %}
                    {% if notification.related_event and notification.related_event.is_active and notification.related_event.created_by.is_banned == False %}
                        <li class="{% if not notification.is_read %}unread{% endif %}">
                            <div class="message-noti">
                                <i class="fa-solid fa-circle"></i>
                                <p class="notification-text">{{ notification.message }}</p>
                            </div>
                            <div class="button-action-noti">
                                <!-- ‡πÉ‡∏ä‡πâ related_request ‡∏Ç‡∏≠‡∏á notification -->
                                {% with notification.related_request as event_request %}
                                    {% if event_request %}
                                        {% if event_request.response_status == "pending" %}
                                            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° YES ‡πÅ‡∏•‡∏∞ NO -->
                                            <div class="action-buttons">
                                                <button class="btn-yes" onclick="handleAction({{ event_request.id }}, 'accept')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                                <button class="btn-no" onclick="handleAction({{ event_request.id }}, 'reject')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                            </div>
                                        {% elif event_request.response_status == "accepted" %}
                                            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
                                            <button class="btn-approved" disabled>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button>
                                        {% elif event_request.response_status == "rejected" %}
                                            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò -->
                                            <button class="btn-rejected" disabled>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß</button>
                                        {% endif %}
                                    {% endif %}
                                {% endwith %}
                            </div>
                            
                            
                        </li>
                    {% endif %}
                
                <!-- ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó response -->
                {% elif notification.notification_type == "response" %}
                    {% if notification.related_event and notification.related_event.is_active and notification.related_event.created_by.is_banned == False %}
                        <li class="{% if not notification.is_read %}unread{% endif %}">
                            <div class="message-noti">
                                <i class="fa-solid fa-circle"></i>
                                <p>{{ notification.message|safe }}</p>
                            </div>
                            <!-- <button class="btn-chat" onclick="window.location.href='/chatroom/{{ notification.related_event.id }}/'">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏ä‡∏ó!</button> -->
                        </li>
                    {% endif %}
                
                <!-- ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó system -->
                {% elif notification.notification_type == "system" %}
                    <li class="{% if not notification.is_read %}unread{% endif %}">
                        <div class="message-noti-system">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            <p>{{ notification.message }}</p>
                        </div>
                    </li>
                {% endif %}
            {% empty %}
                 <li class="no-notifications">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</li>
            {% endfor %}
        </ul>

    </div>
    
    <!-- Popup Modal -->
    <!-- Popup Modal (calendar-detail) -->
<!-- Popup Modal (calendar-detail) -->
<div id="calendarDetailModal" class="calendar-modal">
    <div class="calendar-modal-content">
      <span class="calendar-close">&times;</span>
      <h2 id="calendarModalTitle"></h2>
      <h2>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:<span id="calendarModalCreatedBy"></span></h2>
      <p><strong><i class="fa-solid fa-calendar-days"></i>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> <span id="calendarModalDate"></span></p>
      <p><strong><i class="fa-solid fa-location-dot location-icon"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="calendarModalLocation"></span></p>
      <p><strong><i class="fa-solid fa-shapes"></i>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</strong> <span id="calendarModalCategory"></span></p>
      <p><strong><i class="fa-solid fa-location-dot"></i>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</strong> <span id="calendarModalProvince"></span></p>
      <p><strong>üìù ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> <span id="calendarModalDescription"></span></p>
      <p><strong><i class="fa-solid fa-user"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</strong> <span id="calendarModalMaxParticipants"></span></p>
    </div>
  </div>
  


<!-- <div id="calendarDetailModal" class="calendar-modal">
    <div class="calendar-modal-content">
      <span class="calendar-close">&times;</span>
      <h2 id="calendarModalTitle"></h2>
        <div class="calendar-event-detail">
                <p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong></p>
                <p class="calendar-event-detail-in"><span id="calendarModalDate"></span></p>
        </div>
        <div class="calendar-event-detail">
            <p><strong>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> </p>
            <p class="calendar-event-detail-in"><span id="calendarModalLocation"></span></p>
        </div>
        <div class="calendar-event-detail">
            <p><strong>üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> </p>
            <p class="calendar-event-detail-in"><span id="calendarModalCategory"></span></p>
        </div>
        <div class="calendar-event-detail">
            <p><strong>üåç ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</strong> </p>
            <p class="calendar-event-detail-in"><span id="calendarModalProvince"></span></p>
        </div>
        <div class="calendar-event-detail">
            <p><strong>üìù ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> </p>
            <p class="calendar-event-detail-in"><span id="calendarModalDescription"></span></p>
        </div>
        <div class="calendar-event-detail">
            <p><strong>üë§ ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á:</strong> </p>
            <p class="calendar-event-detail-in"><span id="calendarModalCreatedBy"></span></p>
        </div>
        <div class="calendar-event-detail">
            <p><strong>üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</strong></p>
            <p class="calendar-event-detail-in"> <span id="calendarModalMaxParticipants"></span></p>
        </div>
      
    </div>
  </div> -->
  
   

</div>

<!-- FullCalendar Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 220,  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡πÉ‡∏ô div
        });

        calendar.render();
    });
</script>

<script>
   function markAsRead(notificationId) {
    fetch(`/notifications/${notificationId}/mark-as-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        location.reload();  // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    })
    .catch(error => console.error('Error:', error));
}

 </script> 

<!-- ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß -->
 <script>
    function markAsRead(notificationId) {
    fetch(`/notifications/${notificationId}/mark-as-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            alert('Notification marked as read!');
            location.reload();
        } else {
            alert('Failed to mark notification as read.');
        }
    });
}

 </script>


<!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö -->
<script>

function handleAction(eventRequestId, action) {
    fetch(`/events/requests/${eventRequestId}/handle-request/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: `action=${action}`,  // ‡∏™‡πà‡∏á action: accept ‡∏´‡∏£‡∏∑‡∏≠ reject
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å backend
        location.reload();  // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î! ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
    });
}

</script>

<!-- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  var calendarEl = document.getElementById('calendar');
  var modal = document.getElementById("calendarDetailModal");
  var closeModal = document.getElementsByClassName("calendar-close")[0];

  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    events: '/api/user-events/',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },

    eventClick: function(info) {
      document.getElementById("calendarModalTitle").textContent = info.event.title || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°";
      document.getElementById("calendarModalDate").textContent = new Date(info.event.start).toLocaleString();
      document.getElementById("calendarModalLocation").textContent = info.event.extendedProps.location || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      document.getElementById("calendarModalCategory").textContent = info.event.extendedProps.category || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
      document.getElementById("calendarModalProvince").textContent = info.event.extendedProps.province || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
      document.getElementById("calendarModalDescription").textContent = info.event.extendedProps.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢";
      document.getElementById("calendarModalCreatedBy").textContent = info.event.extendedProps.created_by || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
      document.getElementById("calendarModalMaxParticipants").textContent = info.event.extendedProps.max_participants || 0;

      modal.style.display = "block";
    }
  });

  calendar.render();

  closeModal.onclick = function() {
    modal.style.display = "none";
  };

  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  };
});

</script>

<!-- ‡∏£‡∏µ‡∏´‡∏ô‡πâ‡∏≤ -->






</html>
